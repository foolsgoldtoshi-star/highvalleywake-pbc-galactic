{:deps {zprint/zprint {:mvn/version "1.2.9"}
        org.clojure/clojurescript {:mvn/version "1.11.132"}
        org.clojure/core.async {:mvn/version "1.6.681"}}

 :tasks
 {:requires ([babashka.fs :as fs]
             [babashka.process :refer [shell]]
             [clojure.string :as str]
             [clojure.edn :as edn])

  ;; ğŸŒŒ GALACTIC INFRASTRUCTURE TASKS
  
  msg {:task (defn msg [emoji & parts] 
               (println emoji (str/join " " parts)))}

  ;; ğŸ—ï¸ DUAL BUILD SYSTEM ARCHITECTURE
  
  build:cljs-docs {:doc "Generate ClojureScript documentation DSL"
                   :task (do (msg "ğŸ§¬" "Generating ClojureScript documentation...")
                             (shell {:dir "site-dsl"} "npm" "ci")
                             (shell {:dir "site-dsl"} "npx" "shadow-cljs" "compile" "node-script")
                             (shell {:dir "site-dsl"} "node" "target/main.js")
                             (msg "ğŸŠ" "ClojureScript docs generation complete"))}

  build:localhost {:doc "Build optimized for localhost development"
                   :task (do (msg "ğŸŒ±" "Building for localhost development...")
                             (shell {:dir "build-systems/localhost"} "cp" "svelte.config.js" "../../web/")
                             (shell {:dir "web"} "npm" "ci")
                             (shell {:dir "web"} "npm" "run" "build")
                             (msg "ğŸ–¤" "Localhost build complete"))}

  build:github-pages {:doc "Build optimized for GitHub Pages deployment"
                      :task (do (msg "ğŸŒ" "Building for GitHub Pages...")
                                (shell {:dir "build-systems/github-pages"} "cp" "svelte.config.js" "../../web/")
                                (shell {:dir "web" :env {"GITHUB_PAGES" "true"}} "npm" "ci")
                                (shell {:dir "web" :env {"GITHUB_PAGES" "true"}} "npm" "run" "build")
                                (msg "ğŸš€" "GitHub Pages build complete"))}

  build:all-localhost {:doc "Complete localhost build pipeline"
                       :depends [build:cljs-docs build:localhost]
                       :task (msg "ğŸŒ½" "Complete localhost infrastructure ready!")}

  build:all-github-pages {:doc "Complete GitHub Pages build pipeline"
                          :depends [build:cljs-docs build:github-pages]
                          :task (msg "ğŸŒŒ" "Complete GitHub Pages infrastructure ready!")}

  ;; ğŸ” QUALITY & LINTING
  
  lint:kondo {:doc "Static analysis with clj-kondo"
              :task (do (msg "ğŸ”" "Running clj-kondo analysis...")
                        (try
                          (shell "clj-kondo" "--version")
                          (shell "clj-kondo" "--lint" "site-dsl/src" "docs-cljs")
                          (msg "âœ…" "Static analysis complete")
                          (catch Exception e
                            (msg "âš ï¸" "clj-kondo not found - skipping linting"))))}

  fmt:check {:doc "Check 80-column formatting"
             :task (do (msg "ğŸ“" "Checking code formatting...")
                       (msg "ğŸ’¡" "Use fmt:write to enforce formatting"))}

  fmt:write {:doc "Format all Clojure files to 80 columns"
             :task (do (msg "ğŸ“" "Formatting to 80 columns...")
                       (shell "find" "." "-name" "*.clj" "-exec" "zprint" "--write" "{}" "\\;")
                       (shell "find" "." "-name" "*.cljs" "-exec" "zprint" "--write" "{}" "\\;")
                       (msg "âœ¨" "Code formatting complete"))}

  quality:check {:doc "Run all quality checks"
                 :depends [lint:kondo fmt:check]
                 :task (msg "ğŸ¯" "All quality checks passed!")}

  ;; ğŸŒ DEVELOPMENT SERVERS

  serve:localhost {:doc "Serve localhost development build"
                   :depends [build:all-localhost]
                   :task (do (msg "ğŸŒ±" "Starting localhost development server...")
                             (shell "bb" "-f" "scripts/serve-localhost.clj"))}

  serve:github-pages-test {:doc "Test GitHub Pages build locally"
                           :depends [build:all-github-pages] 
                           :task (do (msg "ğŸŒ" "Testing GitHub Pages build locally...")
                                     (shell "bb" "-f" "scripts/serve-github-pages.clj"))}

  ;; ğŸ§¹ MAINTENANCE

  clean {:doc "Clean all build artifacts"
         :task (do (fs/delete-tree "web/dist" {:force true})
                   (fs/delete-tree "web/.svelte-kit" {:force true})
                   (fs/delete-tree "site-dsl/target" {:force true})
                   (msg "ğŸ§¹" "Build artifacts cleaned"))}

  ;; ğŸ”„ DEVELOPMENT WORKFLOWS

  dev {:doc "Complete development workflow"
       :task (do (msg "ğŸŠ" "Starting galactic development mode...")
                 (future (shell "bb" "build:all-localhost"))
                 (Thread/sleep 3000)
                 (msg "ğŸŒŒ" "Galactic development environment ready!")
                 (shell "bb" "serve:localhost"))}

  ;; ğŸš€ DEPLOYMENT WORKFLOWS

  deploy:github-pages {:doc "Deploy to GitHub Pages" 
                       :depends [build:all-github-pages quality:check]
                       :task (do (msg "ğŸš€" "Deploying to GitHub Pages...")
                                 (shell "git" "add" ".")
                                 (shell "git" "commit" "-m" "ğŸŒŒ Galactic infrastructure deployment")
                                 (shell "git" "push" "origin" "main")
                                 (msg "ğŸŒ" "GitHub Pages deployment complete!"))}

  ;; ğŸ“Š HEALTH CHECKS

  health:check {:doc "Comprehensive system health check"
                :task (do (msg "ğŸ”" "Running galactic health checks...")
                          (shell "bb" "-f" "scripts/health-check.clj")
                          (msg "ğŸ’š" "Galactic infrastructure healthy!"))}

  ;; ğŸ¯ META TASKS

  bootstrap {:doc "Bootstrap new galactic development environment"
             :task (do (msg "ğŸŒŒ" "Bootstrapping galactic infrastructure...")
                       (shell "bb" "clean")
                       (shell "bb" "build:all-localhost") 
                       (shell "bb" "quality:check")
                       (msg "ğŸŠ" "Galactic bootstrap complete!"))}}}

;; ğŸŒ± Enhanced Babashka configuration for post-industrial civilization
;; ğŸ–¤ğŸ¤ğŸ’™ Built with Rich Hickey + Helen Atthowe + NixOS + MMT principles
